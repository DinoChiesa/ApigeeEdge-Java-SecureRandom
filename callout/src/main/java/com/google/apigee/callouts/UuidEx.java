// UuidEx.java
// ------------------------------------------------------------------
//
// The randomUUID() method in the java.util.UUID class uses a
// SecureRandom, but does not allow control over the caching
// or initialization of that SecureRandom. This helper class
// allows it.
//
// Copyright 2018-2022 Google LLC.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

package com.google.apigee.callouts;

import java.security.SecureRandom;

public class UuidEx {
  private final long mostSigBits;
  private final long leastSigBits;

  public static UuidEx randomUUID(SecureRandom prng) {
    byte[] randomBytes = new byte[16];

    prng.nextBytes(randomBytes);
    randomBytes[6] &= 0x0f; /* clear version        */
    randomBytes[6] |= 0x40; /* set to version 4     */
    randomBytes[8] &= 0x3f; /* clear variant        */
    randomBytes[8] |= 0x80; /* set to IETF variant  */
    return new UuidEx(randomBytes);
  }

  private UuidEx(byte[] data) {
    long msb = 0;
    long lsb = 0;
    assert data.length == 16;
    for (int i = 0; i < 8; i++) msb = (msb << 8) | (data[i] & 0xff);
    for (int i = 8; i < 16; i++) lsb = (lsb << 8) | (data[i] & 0xff);
    this.mostSigBits = msb;
    this.leastSigBits = lsb;
  }

  private static String digits(long val, int digits) {
    long hi = 1L << (digits * 4);
    return Long.toHexString(hi | (val & (hi - 1))).substring(1);
  }

  public String toString() {
    return (digits(mostSigBits >> 32, 8)
        + "-"
        + digits(mostSigBits >> 16, 4)
        + "-"
        + digits(mostSigBits, 4)
        + "-"
        + digits(leastSigBits >> 48, 4)
        + "-"
        + digits(leastSigBits, 12));
  }
}
